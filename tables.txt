CREATE TABLE users (
  user_id SERIAL PRIMARY KEY,
  full_name VARCHAR(100) NOT NULL,
  email VARCHAR(120) UNIQUE NOT NULL,
  password_hash TEXT NOT NULL,
  phone VARCHAR(20),
  designation VARCHAR(50),
  department VARCHAR(50),
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE roles (
  role_id SERIAL PRIMARY KEY,
  role_name VARCHAR(50) UNIQUE NOT NULL,
  description TEXT
);

CREATE TABLE user_roles (
  user_id INT REFERENCES users(user_id),
  role_id INT REFERENCES roles(role_id),
  PRIMARY KEY (user_id, role_id)
);

CREATE TABLE asset_categories (
  category_id SERIAL PRIMARY KEY,
  category_name VARCHAR(100) NOT NULL,
  description TEXT
);

CREATE TABLE sub_categories (
  subcategory_id SERIAL PRIMARY KEY,
  category_id INT REFERENCES asset_categories(category_id),
  subcategory_name VARCHAR(100) NOT NULL,
  description TEXT
);

CREATE TABLE vendors (
  vendor_id SERIAL PRIMARY KEY,
  vendor_name VARCHAR(150) NOT NULL,
  contact_person VARCHAR(100),
  phone VARCHAR(20),
  email VARCHAR(120),
  address TEXT
);

CREATE TABLE locations (
  location_id SERIAL PRIMARY KEY,
  location_name VARCHAR(150) NOT NULL,
  address TEXT,
  region VARCHAR(100),
  description TEXT
);

CREATE TABLE assets (
  asset_id SERIAL PRIMARY KEY,
  asset_name VARCHAR(150) NOT NULL,
  category_id INT REFERENCES asset_categories(category_id),
  subcategory_id INT REFERENCES sub_categories(subcategory_id),
  serial_number VARCHAR(100),
  model_number VARCHAR(100),
  purchase_date DATE,
  purchase_cost NUMERIC(12,2),
  vendor_id INT REFERENCES vendors(vendor_id),
  warranty_expiry DATE,
  status VARCHAR(50) DEFAULT 'active',
  current_location_id INT REFERENCES locations(location_id),
  assigned_to INT REFERENCES users(user_id),
  description TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE asset_documents (
  document_id SERIAL PRIMARY KEY,
  asset_id INT REFERENCES assets(asset_id),
  document_type VARCHAR(50),
  file_path TEXT NOT NULL,
  uploaded_by INT REFERENCES users(user_id),
  uploaded_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  expiry_date DATE
);

CREATE TABLE asset_images (
  image_id SERIAL PRIMARY KEY,
  asset_id INT REFERENCES assets(asset_id),
  file_path TEXT NOT NULL,
  uploaded_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE maintenance_records (
  maintenance_id SERIAL PRIMARY KEY,
  asset_id INT REFERENCES assets(asset_id),
  maintenance_type VARCHAR(50),
  performed_by INT REFERENCES users(user_id),
  description TEXT,
  cost NUMERIC(10,2),
  maintenance_date DATE,
  next_due_date DATE
);

CREATE TABLE maintenance_attachments (
  id SERIAL PRIMARY KEY,
  maintenance_id INT REFERENCES maintenance_records(maintenance_id),
  filename VARCHAR(255) NOT NULL,
  url TEXT NOT NULL,
  uploaded_by INT REFERENCES users(user_id),
  uploaded_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE asset_failures (
  failure_id SERIAL PRIMARY KEY,
  asset_id INT REFERENCES assets(asset_id),
  failure_description TEXT,
  failure_date DATE,
  resolved BOOLEAN DEFAULT FALSE,
  resolved_date DATE
);

CREATE TABLE asset_history (
  history_id SERIAL PRIMARY KEY,
  asset_id INT REFERENCES assets(asset_id),
  old_location_id INT REFERENCES locations(location_id),
  new_location_id INT REFERENCES locations(location_id),
  changed_by INT REFERENCES users(user_id),
  change_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE asset_identifiers (
  identifier_id SERIAL PRIMARY KEY,
  asset_id INT REFERENCES assets(asset_id),
  qr_code TEXT,
  rfid_tag TEXT,
  generated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE telemetry (
  id SERIAL PRIMARY KEY,
  asset_id INT REFERENCES assets(asset_id),
  sensor_id VARCHAR(100),
  ts TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  metrics JSONB,
  raw_payload JSONB
);

CREATE TABLE audit_log (
  id SERIAL PRIMARY KEY,
  actor_id INT REFERENCES users(user_id),
  action TEXT NOT NULL,
  target_type VARCHAR(100),
  target_id INT,
  payload JSONB,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
